<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db"
	xmlns:sfdc="http://www.mulesoft.org/schema/mule/sfdc"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/sfdc http://www.mulesoft.org/schema/mule/sfdc/current/mule-sfdc.xsd">

	<sub-flow name="upsertUserInSalesforceFlow" >
         <sfdc:upsert config-ref="Salesforce" externalIdFieldName="Id" type="User" doc:name="Upsert user in Salesforce">
             <sfdc:objects ref="#[payload]"/>
         </sfdc:upsert>
        <logger level="INFO" message="Update User in Salesforce result: #[payload]" doc:name="Logger"/>
    </sub-flow>
    <sub-flow name="insertUserInDatabaseFlow">
        <db:insert config-ref="Database" bulkMode="true" doc:name="Insert user to Database">
            <db:parameterized-query><![CDATA[INSERT INTO User (
	Id,
	Alias,
	Country,
	Email,
	EmailEncodingKey,
	FirstName,
	LanguageLocaleKey,
	LastModifiedById,
	LastModifiedDate,
	LastName,
	LocaleSidKey,
	TimeZoneSidKey,
	Username,
	ProfileId,
	CommunityNickname
) VALUES (
	#[payload.Id],
	#[payload.Alias],
	#[payload.Country],
	#[payload.Email],
	#[payload.EmailEncodingKey],
	#[payload.FirstName],
	#[payload.LanguageLocaleKey],
	CURRENT_USER,
	CURRENT_TIMESTAMP,
	#[payload.LastName],
	#[payload.LocaleSidKey],
	#[payload.TimeZoneSidKey],
	#[payload.Username],
	#[payload.ProfileId],
	#[payload.CommunityNickname]
)]]></db:parameterized-query>
        </db:insert>

        <logger message="Insert user to Database result: #[payload]" level="INFO" doc:name="Logger"/>
    
    </sub-flow>
    <sub-flow name="queryUserFromSalesforceFlow" >
        <sfdc:query-single config-ref="Salesforce" query="dsql:SELECT Id, Email, FirstName, LastName, Alias, Title, TimeZoneSidKey, LocaleSidKey, EmailEncodingKey, ProfileId, LanguageLocaleKey, CommunityNickname FROM User WHERE Email = '#[payload.Email]' and IsActive = true" doc:name="Query user from Salesforce"/>
        <logger level="INFO" message="Query user from Salesforce result: #[payload]" doc:name="Logger"/>
    </sub-flow>
    <sub-flow name="queryUserFromDatabaseFlow" >
                <enricher source="#[payload.isEmpty() ? NullPayload.getInstance() : payload[0]]" target="#[payload]" doc:name="store user">
            <db:select config-ref="Database" doc:name="Query user from Database">
                <db:parameterized-query><![CDATA[SELECT * FROM User WHERE Email = #[payload.Email]]]></db:parameterized-query>
            </db:select>

                    </enricher>
        <logger level="INFO" message="Query user from Database result: #[payload]" doc:name="Logger"/>
    </sub-flow>
    <sub-flow name="deleteUserFromDatabaseFlow" >
        <foreach doc:name="For Each">
            <db:delete config-ref="Database" doc:name="Delete user from Database">
                <db:parameterized-query><![CDATA[DELETE FROM User]]></db:parameterized-query>
            </db:delete>

        </foreach>
    </sub-flow>
    <sub-flow name="deleteUserFromSalesforceFlow" >
        <sfdc:update config-ref="Salesforce" type="User" doc:name="Salesforce">
            <sfdc:objects ref="#[payload]"/>
        </sfdc:update>
    </sub-flow>

</mule>
